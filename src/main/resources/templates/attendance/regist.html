<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link th:href="@{/css/style.css}" rel="stylesheet" />
<style>
	.time-selectors {
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100%;
	}
 
	.time-selectors select {
		width: 90px;
		padding: 10px;
		font-size: 1em;
		border-radius: 10px;
		margin-right: 5px;
	}
 
	.form-control{
		width: 150px;
		padding: 10px 20px;
		font-size: 1em;
		border-radius: 10px;
		text-align: center;
	}
</style>
 
<title>勤怠登録画面</title>
</head>
<body>
	
	<script th:src="@{/js/attendance.js}"></script>
	<div class="container">
		<div class="component">
			<p>ユーザ名: <span th:text="${loginUser.name}"></span></p>
			<p>ユーザID: <span th:text="${loginUser.userId}"></span></p>
			<p>ステータス:</p>
		</div>
	
	<form id="attendanceForm" th:action="@{/attendance/regist}" method="post" th:object="${formList}">
		<div style="display: flex; align-items: center;">
			<label>表示年月：</label>
	
			<select name="year">
				<option value="" th:text="'選択してください'" th:selected="${selectedYear == null}"></option>
				<option th:each="year : ${#numbers.sequence(2023, 2025)}" th:value="${year}" th:text="${year}"
					th:selected="${year == selectedYear}"></option>
			</select>
			<p for="year">年</p>
	
			<select name="month">
				<option value="" th:text="'選択してください'" th:selected="${selectedMonth == null}"></option>
				<option th:each="month : ${#numbers.sequence(1, 12)}" th:value="${month}" th:text="${month}"
					th:selected="${month == selectedMonth}"></option>
			</select>
			<p for="month">月</p>
	
			<button type="submit" name="display">表示</button>
		</div>
	</form>
	
		
		
		<div style="display: flex; justify-content: flex-end;">
			<form th:action="@{/attendance/regist}" method="post" th:if="${session.loginUser.role == '0002'}">
				<input type="submit" value="却下" class="btn btn-mgmt" />
			</form>
			<form th:action="@{/attendance/regist}" method="post" th:if="${session.loginUser.role == '0002'}">
				<input type="submit" value="承認" class="btn btn-mgmt" />
			</form>
			<form th:action="@{/attendance/regist}" method="post">
				<input type="submit" value="承認申請" class="btn btn-mgmt" style="margin-right: 10px;" />
			</form>
			<form th:action="@{/attendance/regist}" method="post" onsubmit="return validateAttendanceInput();">
				<input type="submit" value="登録" name="regist" class="btn btn-mgmt" />
			</form>
		</div>
		
		<table class="table data-table">
			<thead>
				<tr>
					<th class="w150">承認申請者</th>
					<th class="w120">申請対象年月</th>
					<th class="w120">申請日</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td class="w150"></td>
					<td class="w120"></td>
					<td class="w120"></td>
				</tr>
			</tbody>
		</table>
	
		<table class="table table-hover">
			<thead>
				<tr>
					<th class="w40">日付</th>
					<th class="w40">曜日</th>
					<th class="w100">勤務状況</th>
					<th class="w120">出勤時間</th>
					<th class="w120">退勤時間</th>
					<th class="w150">備考</th>
				</tr>
			</thead>
			<tbody id="attendanceTableBody" style="overflow-y: scroll;">
				<tr th:each="formList, stat : *{attendanceFormList.attendanceFormList}">
					<td class="w40" th:text="${formList.formattedDate}">
						<input type="hidden" th:name="|attendanceFormList[${stat.index}].formattedDate|"
							th:value="${formList.formattedDate}" />
					</td>
					<td class="w40" th:text="${formList.formattedWeek}">
						<input type="hidden" th:name="|attendanceFormList[${stat.index}].formattedWeek|"
							th:value="${formList.formattedWeek}" />
					</td>
					<td class="w100">
						<select name="attendanceFormList[${stat.index}].status">
                            <option value="0" th:selected="${formList.status == 0}">通常出勤</option>
                            <option value="1" th:selected="${formList.status == 1}">休日</option>
                            <option value="2" th:selected="${formList.status == 2}">祝日</option>
                            <option value="3" th:selected="${formList.status == 3}">遅刻</option>
                            <option value="4" th:selected="${formList.status == 4}">有給</option>
                            <option value="5" th:selected="${formList.status == 5}">欠勤</option>
                            <option value="6" th:selected="${formList.status == 6}">早退</option>
                            <option value="7" th:selected="${formList.status == 7}">時間外勤務</option>
                            <option value="8" th:selected="${formList.status == 8}">振替出勤</option>
                            <option value="9" th:selected="${formList.status == 9}">振替休日</option>
                            <option value="10" th:selected="${formList.status == 10}">代替出勤</option>
                            <option value="11" th:selected="${formList.status == 11}">代替休日</option>
                        </select>
						<input type="hidden" th:name="|attendanceFormList[${stat.index}].status|" th:value="${formList.status}" />
					</td>
					<td class="w120">
						<select name="attendanceFormList[${stat.index}].startHour">
							<th:block th:each="hour : ${hours}">
            <option th:value="${hour}" th:selected="${formList.startHour == hour}">
                
                <span th:text="${hour}"></span>
            </option>
        </th:block>
						</select>
						<select name="attendanceFormList[${stat.index}].startMinute">
							 <th:block th:each="minute : ${minutes}">
            <option th:value="${minute}" th:selected="${formList.startMinute == minute}">
     
                <span th:text="${minute}"></span>
            </option>
        </th:block>
						</select>
					</td>
					
					<script>
						
						function populateTimeSelects() {
							const hourSelects = document.querySelectorAll('select[name$=".startHour"]');
							const minuteSelects = document.querySelectorAll('select[name$=".startMinute"]');

							hourSelects.forEach(select => {
								for (let hour = 0; hour < 24; hour++) {
									const option = document.createElement('option');
									option.value = hour;
									option.textContent = hour.toString().padStart(2, '0');
									select.appendChild(option);
								}
							});

							minuteSelects.forEach(select => {
								for (let minute = 0; minute < 60; minute++) {
									const option = document.createElement('option');
									option.value = minute;
									option.textContent = minute.toString().padStart(2, '0');
									select.appendChild(option);
								}
							});
						}

						// 選択肢を反映する関数
    function setSelectValues() {
        const timeData = document.querySelectorAll('td.w120');

        timeData.forEach(td => {
            const hourSelect = td.querySelector('select.hour-select');
            const minuteSelect = td.querySelector('select.minute-select');

            // 既存データがあれば、それを選択状態にする
            const startHour = td.getAttribute('data-start-hour');
            const startMinute = td.getAttribute('data-start-minute');

            if (startHour !== null) {
                hourSelect.value = startHour;
            }
            if (startMinute !== null) {
                minuteSelect.value = startMinute;
            }
        });
    }

    // DOMContentLoaded イベントでスクリプトを実行
    document.addEventListener('DOMContentLoaded', () => {
        populateTimeSelects();
        setSelectValues();
    });
					</script>
					<td class="w120">
						<select name="attendanceFormList[${stat.index}].endHour">
        <th:block th:each="hour : ${hours}">
            <option th:value="${hour}" th:selected="${formList.endHour == hour}">
                <span th:text="${hour}"></span>
            </option>
        </th:block>
    </select>
    時

    <select name="attendanceFormList[${stat.index}].endMinute">
        <th:block th:each="minute : ${minutes}">
            <option th:value="${minute}" th:selected="${formList.endMinute == minute}">
                <span th:text="${minute}"></span>
            </option>
        </th:block>
    </select>
    分
					</td>
					<td class="w150" th:text="${formList.remarks}">
						<input type="hidden" th:name="|attendanceFormList[${stat.index}].remarks|" th:value="${formList.remarks}" />
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	
</body>
</html>